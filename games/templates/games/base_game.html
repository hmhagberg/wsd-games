{% extends "games/base.html" %}

{% load staticfiles %}

{% block title %}WSD-Games - {{game.name}}{% endblock %}

{% block header %}{{game.name}}{% endblock %}

{% block content %}
<script>
    /* global $ */
    // Handle messages between the game site and the game in the iframe
    $(document).ready(function() {
        'use strict';
        $(window).on('message', function(evt) {
            var data = evt.originalEvent.data;
            if (data.messageType === "LOAD_REQUEST") {
                var game_data = "{{ownership.saved_data}}";
                var child = document.getElementById("game").contentWindow;
                var msg = {"messageType": "LOAD", "gameState": {"score": {{ownership.saved_score}}, "playerItems": game_data.split(",")}};
                child.postMessage(msg, "*");
            }
            else if (data.messageType === "SCORE") {
                if (!isNaN(data.score)){
                    $.ajax({
                        'type': 'POST',
                        'url': '{% url 'games.views.game' game.slug %}',
                        'headers': { "X-CSRFToken": '{{ csrf_token }}' },
                        'data': data
                    });
                }
            }
            else if (data.messageType === "SAVE") {
                if (!isNaN(data.gameState.score)) {
                    $.ajax({
                        'type': 'POST',
                        'url': '{% url 'games.views.game' game.slug %}',
                        'headers': { "X-CSRFToken": '{{ csrf_token }}' },
                        'data': data
                    });
                }
            }
        });
        $( "#message" ).click(function() {
            var child = document.getElementById("game").contentWindow;
            var msg = {"messageType": "MESSAGE","message": "TEST MESSAGE"};
            child.postMessage(msg, "*");
        });
    });

</script>
    {% if ownership_status == "owned" %}
        <iframe id="game" src="{{game.url}}"></iframe>
        <button id="message" class="hidden">Send message</button>
    {% elif ownership_status == "developer"  %}
        <h1>YOU DEVELOPED THIS GAME</h1>
    {% else %}
        <div class="modal fade" id="modal{{game.id}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">{{game.name}}</h4>
                    </div>
                    <div class="modal-body">
                        <div class="img-container">
                            <img src="{{game.image_url}}" class="img-responsive img-circle" alt="{{game.developer.name}} image">
                        </div>
                        <p>{{game.description}}</p>
                        <p class="developer">Developer: <a href="{% url 'games.views.developer' game.developer.slug %}">{{game.developer.name}}</a></p>
                        <p>Categories: {% for category in game.categories.all %}<a href="{% url 'games.views.category' category.slug %}">{{category}}</a> | {% endfor %}</p>
                        {% if game.price == 0 %}
                            <p class="price">Price: Free</p>
                        {% else %}
                            <p class="price">Price: {{game.price|floatformat:2}}</p>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        {% if user.is_authenticated %}
                            {% if user.is_player %}
                                <form action="{% url 'payment' %}" method="POST">
                                    {% csrf_token %}
                                    <input type="hidden" name="game_id" value="{{ game.id }}">
                                    <button type="button submit" class="btn btn-primary">Buy Game</button>
                                </form>
                            {% endif %}
                        {% endif %}
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <script type="text/javascript">$('#modal{{game.id}}').modal('show');</script>
    {% endif %}

    <!-- Google+ Share button-->
    <div id="share-button-container">
        <span class="hidden" itemprop="name">{{game.name}} - {{game.description}}</span>
        <img class="hidden" itemprop="image" src="{{game.image_url}}">
        <div class="g-plus" data-action="share" data-annotation="none" data-height="24"></div>
        <script type="text/javascript">
          (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/platform.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
          })();
        </script>
    </div>

    <!-- Highscores -->
    <div id="highscore-container">
        <h3>Highscores</h3>
        <ol id="highscores">
            {% for highscore in game.get_highscores %}
                <li>{{highscore.player.user.username}} {{highscore.highscore}}</li>
            {% endfor %}
        </ol>
    </div>
{% endblock %}